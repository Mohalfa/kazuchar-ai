<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KazuChar.AI - Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-dark:#0f0f1a;--bg-card:#1a1a2e;--bg-input:#252542;--accent:#6c5ce7;--accent-light:#a29bfe;--text:#ffffff;--text-muted:#8888aa;--border:rgba(255,255,255,0.1);--success:#00cec9;--error:#ff7675}*{font-family:'Poppins',sans-serif;box-sizing:border-box}body{background:var(--bg-dark);height:100vh;display:flex;flex-direction:column;color:var(--text);margin:0}.chat-header{background:rgba(26,26,46,0.95);backdrop-filter:blur(20px);padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.back-btn{background:var(--bg-input);border:1px solid var(--border);color:var(--text);width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;text-decoration:none}.char-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-light));display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}.char-avatar img{width:100%;height:100%;object-fit:cover}.char-info h5{margin:0;font-size:15px;font-weight:600}.char-info small{color:var(--success);font-size:12px}.header-right{margin-left:auto;display:flex;align-items:center;gap:10px}.lang-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer}.token-badge{background:rgba(253,203,110,0.15);border:1px solid rgba(253,203,110,0.3);color:#fdcb6e;padding:8px 12px;border-radius:16px;font-weight:700;font-size:12px}.action-btn{background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:8px 14px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer}.action-btn.danger{color:var(--error)}.chat-area{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}.message{display:flex;gap:10px;max-width:85%;animation:msgIn 0.3s ease}@keyframes msgIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.message.user{flex-direction:row-reverse;align-self:flex-end}.message-avatar{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;overflow:hidden}.message.bot .message-avatar{background:linear-gradient(135deg,var(--accent),var(--accent-light))}.message.user .message-avatar{background:linear-gradient(135deg,#fd79a8,#e84393)}.message-avatar img{width:100%;height:100%;object-fit:cover}.message-content{background:var(--bg-card);border:1px solid var(--border);padding:14px 18px;border-radius:18px;font-size:14px;line-height:1.7}.message.user .message-content{background:linear-gradient(135deg,var(--accent),var(--accent-light));border:none}.message.bot .message-content{border-radius:4px 18px 18px 18px}.message.user .message-content{border-radius:18px 4px 18px 18px}.message-content img{max-width:180px;max-height:180px;border-radius:12px;margin-top:10px;cursor:pointer}.typing-indicator .message-content{display:flex;gap:6px;padding:18px 24px}.typing-dot{width:10px;height:10px;background:var(--accent-light);border-radius:50%;animation:bounce 1.4s infinite}.typing-dot:nth-child(2){animation-delay:0.2s}.typing-dot:nth-child(3){animation-delay:0.4s}@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-12px)}}.welcome-message{text-align:center;padding:60px 20px;color:var(--text-muted)}.welcome-message h3{color:var(--text);margin-bottom:10px;font-size:22px}.welcome-message .icon{font-size:60px;margin-bottom:20px;animation:wave 2s infinite;display:inline-block}@keyframes wave{0%,100%{transform:rotate(0deg)}25%{transform:rotate(15deg)}75%{transform:rotate(-15deg)}}.input-area{padding:14px 16px 20px;background:rgba(26,26,46,0.95);border-top:1px solid var(--border)}.no-token-warning{background:rgba(255,118,117,0.15);border:1px solid var(--error);padding:12px;border-radius:12px;text-align:center;color:var(--error);font-size:13px;margin-bottom:12px}.file-preview{display:none;margin-bottom:12px;padding:12px;background:var(--bg-input);border-radius:12px;align-items:center;gap:12px}.file-preview.active{display:flex}.file-preview img{width:60px;height:60px;object-fit:cover;border-radius:10px}.file-preview .info{flex:1;font-size:13px;color:var(--text-muted)}.file-preview .remove{background:var(--error);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer}.input-container{display:flex;gap:10px;align-items:flex-end}.attach-btn{width:48px;height:48px;background:var(--bg-input);border:1px solid var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);flex-shrink:0;cursor:pointer}.input-container textarea{flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:var(--text);font-size:14px;resize:none;min-height:48px;max-height:120px}.input-container textarea:focus{outline:none;border-color:var(--accent)}.send-btn{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent-light));border:none;border-radius:14px;display:flex;align-items:center;justify-content:center;color:white;flex-shrink:0;cursor:pointer}.toast{background:var(--bg-card);border:1px solid var(--border);border-radius:12px}@media(max-width:576px){.action-btns{display:none!important}.message{max-width:90%}.char-avatar{width:42px;height:42px}.char-info h5{font-size:14px}.token-badge{padding:6px 10px;font-size:11px}.message-avatar{width:32px;height:32px}.message-content{padding:12px 14px;font-size:13px}.attach-btn,.send-btn{width:44px;height:44px}}
    </style>
</head>
<body>
    <header class="chat-header">
        <a href="/dashboard.html" class="back-btn"><i class="bi bi-chevron-left"></i></a>
        <div class="char-avatar" id="charAvatar">A</div>
        <div class="char-info"><h5><span id="charName">Loading...</span><span class="badge bg-danger ms-2" id="nsfwBadge" style="display:none;font-size:9px;">ðŸ”ž</span></h5><small><i class="bi bi-circle-fill text-success me-1" style="font-size:6px;"></i>Online</small></div>
        <div class="header-right">
            <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)"><option value="id">ðŸ‡®ðŸ‡© ID</option><option value="en">ðŸ‡ºðŸ‡¸ EN</option></select>
            <div class="token-badge"><i class="bi bi-coin me-1"></i><span id="tokenCount">0</span></div>
            <div class="action-btns d-none d-md-flex gap-2">
                <button class="action-btn" id="btnClear" onclick="clearChat()"><i class="bi bi-eraser me-1"></i>Hapus</button>
                <button class="action-btn danger" id="btnReset" onclick="resetChat()"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
            </div>
        </div>
    </header>
    <div class="chat-area" id="chatArea"><div class="welcome-message" id="welcome"><div class="icon">ðŸ‘‹</div><h3 id="welcomeTitle">Hai! Siap ngobrol</h3><p id="welcomeText">Kirim pesan untuk mulai ðŸ’¬</p></div></div>
    <div class="input-area">
        <div class="no-token-warning" id="noTokenWarning" style="display:none;"><i class="bi bi-exclamation-triangle me-2"></i><span id="noTokenText">Token habis!</span></div>
        <div class="file-preview" id="filePreview"><img id="previewImg" src=""><span class="info" id="previewInfo"></span><button class="remove" onclick="removeFile()"><i class="bi bi-x"></i></button></div>
        <div class="input-container" id="inputContainer">
            <button class="attach-btn" onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
            <textarea id="messageInput" placeholder="Ketik pesan..." rows="1" onkeydown="handleKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()"><i class="bi bi-send"></i></button>
        </div>
    </div>
    <div class="toast-container position-fixed top-0 end-0 p-3"><div id="toast" class="toast"><div class="toast-body d-flex align-items-center gap-2"><i class="bi" id="toastIcon"></i><span id="toastMessage"></span></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = window.location.origin + '/api';
        let token = localStorage.getItem('kazuchar_token'), user = JSON.parse(localStorage.getItem('kazuchar_user') || '{}');
        let character = null, userTokens = user.tokens || 0, selectedFile = null;
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id') || urlParams.get('character');
        let currentLang = urlParams.get('lang') || localStorage.getItem('kazuchar_lang') || 'id';
        
        const translations = {
            id: {
                btnClear: 'Hapus', btnReset: 'Reset', welcomeTitle: 'Hai! Siap ngobrol',
                welcomeText: 'Kirim pesan untuk mulai ðŸ’¬', noTokenText: 'Token habis! Hubungi admin.',
                inputPlaceholder: 'Ketik pesan...', clearConfirm: 'Hapus tampilan chat?',
                resetConfirm: 'Reset chat? AI akan lupa semua percakapan!',
                chatCleared: 'Chat dihapus', chatReset: 'Chat direset',
                clearedTitle: 'Chat dibersihkan', clearedText: 'AI masih ingat percakapan sebelumnya',
                resetTitle: 'Chat direset', resetText: 'AI sudah lupa semua percakapan',
                sendError: 'Gagal mengirim pesan', tokenEmpty: 'Token habis!'
            },
            en: {
                btnClear: 'Clear', btnReset: 'Reset', welcomeTitle: 'Hi! Ready to chat',
                welcomeText: 'Send a message to start ðŸ’¬', noTokenText: 'No tokens left! Contact admin.',
                inputPlaceholder: 'Type a message...', clearConfirm: 'Clear chat display?',
                resetConfirm: 'Reset chat? AI will forget everything!',
                chatCleared: 'Chat cleared', chatReset: 'Chat reset',
                clearedTitle: 'Chat cleared', clearedText: 'AI still remembers previous conversation',
                resetTitle: 'Chat reset', resetText: 'AI has forgotten everything',
                sendError: 'Failed to send message', tokenEmpty: 'No tokens left!'
            }
        };
        
        const t = key => translations[currentLang][key] || key;
        
        const applyTranslations = () => {
            document.getElementById('btnClear').innerHTML = `<i class="bi bi-eraser me-1"></i>${t('btnClear')}`;
            document.getElementById('btnReset').innerHTML = `<i class="bi bi-arrow-counterclockwise me-1"></i>${t('btnReset')}`;
            document.getElementById('welcomeTitle').textContent = t('welcomeTitle');
            document.getElementById('welcomeText').textContent = t('welcomeText');
            document.getElementById('noTokenText').textContent = t('noTokenText');
            document.getElementById('messageInput').placeholder = t('inputPlaceholder');
        };
        
        if (!token) window.location.href = '/';
        if (!characterId) window.location.href = '/dashboard.html';
        
        const showToast = (msg, type = 'success') => { 
            document.getElementById('toastIcon').className = 'bi bi-' + (type === 'success' ? 'check-circle-fill text-success' : 'exclamation-circle-fill text-danger'); 
            document.getElementById('toastMessage').textContent = msg; 
            new bootstrap.Toast(document.getElementById('toast')).show(); 
        };
        
        const changeLanguage = lang => { 
            currentLang = lang; 
            localStorage.setItem('kazuchar_lang', lang); 
            applyTranslations();
        };
        
        const handleFile = e => { 
            const file = e.target.files[0]; 
            if (!file) return; 
            selectedFile = file; 
            const preview = document.getElementById('filePreview'), img = document.getElementById('previewImg'); 
            if (file.type.startsWith('image/')) { 
                const reader = new FileReader(); 
                reader.onload = ev => { img.src = ev.target.result; img.style.display = 'block'; }; 
                reader.readAsDataURL(file); 
            } else img.style.display = 'none'; 
            document.getElementById('previewInfo').textContent = file.name; 
            preview.classList.add('active'); 
        };
        
        const removeFile = () => { 
            selectedFile = null; 
            document.getElementById('fileInput').value = ''; 
            document.getElementById('filePreview').classList.remove('active'); 
        };
        
        document.addEventListener('DOMContentLoaded', () => { 
            document.getElementById('langSelect').value = currentLang; 
            document.getElementById('tokenCount').textContent = userTokens; 
            applyTranslations();
            checkTokens(); 
            loadCharacter(); 
            loadHistory(); 
        });
        
        const checkTokens = async () => { 
            try { 
                const res = await fetch(API + '/auth/me', { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                if (data.user) { 
                    userTokens = data.user.tokens; 
                    document.getElementById('tokenCount').textContent = userTokens; 
                    if (userTokens <= 0) { 
                        document.getElementById('noTokenWarning').style.display = 'block'; 
                        document.getElementById('inputContainer').style.display = 'none'; 
                    } 
                } 
            } catch(e) {} 
        };
        
        const loadCharacter = async () => { 
            try { 
                const res = await fetch(API + '/characters/' + characterId, { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                if (data.character) { 
                    character = data.character; 
                    document.getElementById('charName').textContent = character.name; 
                    document.title = 'Chat - ' + character.name; 
                    if (character.nsfw_enabled) document.getElementById('nsfwBadge').style.display = 'inline'; 
                    document.getElementById('charAvatar').innerHTML = character.profile_photo ? '<img src="' + character.profile_photo + '">' : character.name.charAt(0); 
                } else { 
                    showToast('Character not found', 'error'); 
                    setTimeout(() => location.href = '/dashboard.html', 1500); 
                } 
            } catch(e) {} 
        };
        
        const loadHistory = async () => { 
            try { 
                const res = await fetch(API + '/chat/history/' + characterId, { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                if (data.history && data.history.length > 0) { 
                    document.getElementById('welcome').style.display = 'none'; 
                    data.history.forEach(msg => addMessage(msg.message, msg.role === 'user', msg.image_path)); 
                } 
            } catch(e) {} 
        };
        
        const handleKey = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        
        const sendMessage = async () => { 
            const input = document.getElementById('messageInput'); 
            const message = input.value.trim(); 
            if (!message && !selectedFile) return; 
            if (userTokens <= 0) { showToast(t('tokenEmpty'), 'error'); return; } 
            const btn = document.getElementById('sendBtn'); 
            btn.disabled = true; 
            input.disabled = true; 
            document.getElementById('welcome').style.display = 'none'; 
            const imageUrl = selectedFile && selectedFile.type.startsWith('image/') ? URL.createObjectURL(selectedFile) : null; 
            addMessage(message || 'ðŸ“Ž ' + ((selectedFile && selectedFile.name) || 'File'), true, imageUrl); 
            input.value = ''; 
            input.style.height = 'auto'; 
            showTyping(); 
            const formData = new FormData(); 
            formData.append('message', message); 
            formData.append('characterId', characterId); 
            formData.append('lang', currentLang); 
            if (selectedFile) formData.append('file', selectedFile); 
            removeFile(); 
            try { 
                const res = await fetch(API + '/chat', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData }); 
                const data = await res.json(); 
                hideTyping(); 
                if (data.success) { 
                    addMessage(data.response, false); 
                    userTokens = data.tokens; 
                    document.getElementById('tokenCount').textContent = userTokens; 
                    if (userTokens <= 0) { 
                        document.getElementById('noTokenWarning').style.display = 'block'; 
                        document.getElementById('inputContainer').style.display = 'none'; 
                    } 
                } else showToast(data.error || 'Error', 'error'); 
            } catch(e) { hideTyping(); showToast(t('sendError'), 'error'); } 
            btn.disabled = false; 
            input.disabled = false; 
            input.focus(); 
        };
        
        const addMessage = (text, isUser, imagePath) => { 
            const chatArea = document.getElementById('chatArea'); 
            const div = document.createElement('div'); 
            div.className = 'message ' + (isUser ? 'user' : 'bot'); 
            const avatarContent = isUser ? (user.profile_photo ? '<img src="' + user.profile_photo + '">' : (user.name && user.name.charAt(0) || 'U')) : (character && character.profile_photo ? '<img src="' + character.profile_photo + '">' : (character && character.name.charAt(0) || 'A')); 
            const imageHtml = imagePath ? '<img src="' + imagePath + '" onclick="window.open(this.src)">' : ''; 
            div.innerHTML = '<div class="message-avatar">' + avatarContent + '</div><div class="message-content">' + formatMessage(text) + imageHtml + '</div>'; 
            chatArea.appendChild(div); 
            chatArea.scrollTop = chatArea.scrollHeight; 
        };
        
        const formatMessage = text => text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em style="color:var(--accent-light)">$1</em>').replace(/\n/g, '<br>');
        
        const showTyping = () => { 
            const chatArea = document.getElementById('chatArea'); 
            const div = document.createElement('div'); 
            div.className = 'message bot typing-indicator'; 
            div.id = 'typing'; 
            const avatarContent = character && character.profile_photo ? '<img src="' + character.profile_photo + '">' : (character && character.name.charAt(0) || 'A'); 
            div.innerHTML = '<div class="message-avatar">' + avatarContent + '</div><div class="message-content"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>'; 
            chatArea.appendChild(div); 
            chatArea.scrollTop = chatArea.scrollHeight; 
        };
        
        const hideTyping = () => { const typing = document.getElementById('typing'); if (typing) typing.remove(); };
        
        const clearChat = async () => { 
            if (!confirm(t('clearConfirm'))) return; 
            await fetch(API + '/chat/clear', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ characterId }) }); 
            document.getElementById('chatArea').innerHTML = `<div class="welcome-message"><div class="icon">âœ¨</div><h3>${t('clearedTitle')}</h3><p>${t('clearedText')}</p></div>`; 
            showToast(t('chatCleared')); 
        };
        
        const resetChat = async () => { 
            if (!confirm(t('resetConfirm'))) return; 
            await fetch(API + '/chat/reset', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ characterId }) }); 
            document.getElementById('chatArea').innerHTML = `<div class="welcome-message"><div class="icon">ðŸ”„</div><h3>${t('resetTitle')}</h3><p>${t('resetText')}</p></div>`; 
            showToast(t('chatReset')); 
        };
        
        document.getElementById('messageInput').addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px'; });
    </script>
</body>
</html>
