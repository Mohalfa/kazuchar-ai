<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KazuChar.AI - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f0f1a; --bg-card: #1a1a2e; --bg-input: #252542; --accent: #6c5ce7; --accent-light: #a29bfe; --text: #ffffff; --text-muted: #8888aa; --border: rgba(255,255,255,0.1); --success: #00cec9; --error: #ff7675; --warning: #fdcb6e; }
        * { font-family: 'Poppins', sans-serif; box-sizing: border-box; }
        body { background: var(--bg-dark); color: var(--text); min-height: 100vh; margin: 0; }
        .navbar { background: rgba(26, 26, 46, 0.95) !important; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .navbar-brand { font-weight: 700; }
        .navbar-brand span { color: var(--accent-light); }
        .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .token-badge { background: rgba(253,203,110,0.15); border: 1px solid rgba(253,203,110,0.3); color: var(--warning); padding: 8px 14px; border-radius: 20px; font-weight: 700; font-size: 13px; }
        .user-dropdown { background: var(--bg-input); border: 1px solid var(--border); border-radius: 25px; padding: 5px 14px 5px 5px; cursor: pointer; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 14px; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dropdown-menu { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .dropdown-item { color: var(--text-muted); padding: 10px 16px; border-radius: 8px; }
        .dropdown-item:hover { background: var(--bg-input); color: var(--text); }
        .dropdown-divider { border-color: var(--border); }
        .form-control, .form-select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 12px; padding: 12px 16px; }
        .form-control:focus, .form-select:focus { background: var(--bg-input); border-color: var(--accent); color: var(--text); box-shadow: 0 0 0 3px rgba(108,92,231,0.15); }
        .form-control::placeholder { color: var(--text-muted); }
        .form-control:disabled { background: var(--bg-dark); color: var(--text-muted); opacity: 0.7; }
        .form-label { color: var(--text-muted); font-size: 12px; font-weight: 600; }
        .btn-filter { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); border-radius: 20px; padding: 10px 20px; font-weight: 600; font-size: 13px; }
        .btn-filter:hover, .btn-filter.active { background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-color: transparent; color: white; }
        .btn-filter.nsfw.active { background: linear-gradient(135deg, var(--error), #fab1a0); }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-light)); border: none; border-radius: 12px; padding: 12px 24px; font-weight: 600; }
        .btn-outline-light { border: 1px solid var(--border); color: var(--text-muted); border-radius: 12px; }
        .btn-outline-light:hover { background: var(--bg-input); border-color: var(--accent); color: var(--text); }
        .section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.2rem; }
        .section-title .count { color: #ffffff; font-weight: 600; }
        .char-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; cursor: pointer; height: 100%; transition: all 0.3s; }
        .char-card:hover { transform: translateY(-6px); border-color: var(--accent); }
        .char-image { height: 140px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; justify-content: center; font-size: 48px; position: relative; overflow: hidden; }
        .char-image img { width: 100%; height: 100%; object-fit: cover; }
        .char-badge { position: absolute; padding: 4px 10px; border-radius: 10px; font-size: 10px; font-weight: 700; }
        .char-badge.nsfw { background: var(--error); color: white; top: 8px; right: 8px; }
        .char-badge.gender { background: rgba(0,0,0,0.6); color: white; bottom: 8px; left: 8px; }
        .char-info { padding: 14px; }
        .char-info h5 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .char-info .role { color: var(--accent-light); font-size: 12px; margin-bottom: 8px; }
        .char-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .char-tag { padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; }
        .continue-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; cursor: pointer; }
        .continue-card:hover { border-color: var(--accent); }
        .continue-img { width: 90px; height: 110px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; justify-content: center; font-size: 28px; overflow: hidden; flex-shrink: 0; }
        .continue-img img { width: 100%; height: 100%; object-fit: cover; }
        .continue-info { padding: 12px; flex: 1; }
        .continue-info h6 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .continue-info .meta { font-size: 11px; color: var(--text-muted); }
        .pagination .page-link { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 10px !important; margin: 0 3px; min-width: 40px; text-align: center; font-weight: 600; font-size: 13px; padding: 8px 12px; }
        .pagination .page-link:hover { border-color: var(--accent); }
        .pagination .page-item.active .page-link { background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-color: transparent; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; }
        .modal-header { border-bottom: 1px solid var(--border); }
        .modal-footer { border-top: 1px solid var(--border); }
        .btn-close { filter: invert(1); }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; justify-content: center; font-size: 40px; overflow: hidden; margin: 0 auto 16px; border: 3px solid var(--accent-light); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-bubble { position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
        .chat-bubble-btn { width: 56px; height: 56px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border: none; border-radius: 50%; font-size: 22px; box-shadow: 0 8px 25px rgba(108,92,231,0.4); position: relative; color: white; display: flex; align-items: center; justify-content: center; }
        .chat-bubble-btn .badge { position: absolute; top: -4px; right: -4px; }
        .chat-window { position: absolute; bottom: 70px; right: 0; width: 320px; max-width: calc(100vw - 40px); height: 420px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; display: none; flex-direction: column; overflow: hidden; }
        .chat-window.show { display: flex; }
        .chat-header { padding: 14px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; gap: 12px; }
        .chat-header .avatar { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .chat-header h6 { color: white; margin: 0; font-size: 14px; }
        .chat-header small { color: rgba(255,255,255,0.8); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 13px; }
        .chat-msg.from-admin { background: var(--bg-input); align-self: flex-start; }
        .chat-msg.from-me { background: linear-gradient(135deg, var(--accent), var(--accent-light)); align-self: flex-end; }
        .chat-input { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: center; }
        .chat-input input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 20px; padding: 10px 16px; color: var(--text); font-size: 13px; min-width: 0; }
        .chat-input input:focus { outline: none; border-color: var(--accent); }
        .chat-input button { min-width: 44px !important; width: 44px !important; height: 44px !important; background: linear-gradient(135deg, var(--accent), var(--accent-light)) !important; border: none !important; border-radius: 50% !important; color: white !important; display: flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; cursor: pointer; font-size: 18px; padding: 0 !important; }
        .chat-input button:hover { transform: scale(1.05); }
        .chat-input button i { font-size: 18px; }
        .chat-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1049; }
        .chat-overlay.show { display: block; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; }
        .lang-select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 10px; padding: 8px 12px; font-size: 13px; cursor: pointer; }
        .update-note { color: var(--text-muted); font-size: 12px; text-align: center; margin-bottom: 16px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        @media (max-width: 576px) { 
            .navbar-brand { font-size: 1rem; } 
            .logo-icon { width: 32px; height: 32px; font-size: 16px; } 
            .token-badge { padding: 6px 10px; font-size: 11px; } 
            .user-avatar { width: 28px; height: 28px; } 
            #userName { display: none; } 
            .lang-select { padding: 6px 8px; font-size: 11px; } 
            .char-image { height: 120px; } 
            .char-info { padding: 10px; } 
            .continue-img { width: 70px; height: 90px; } 
            .chat-bubble { bottom: 16px; right: 16px; z-index: 1050; } 
            .chat-bubble-btn { width: 50px; height: 50px; } 
            .chat-window { 
                position: fixed !important; 
                bottom: 0 !important; 
                left: 0 !important; 
                right: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
                height: 70vh !important; 
                border-radius: 20px 20px 0 0 !important; 
                margin: 0 !important;
            } 
            .modal-content { margin: 10px; } 
            .profile-avatar { width: 80px; height: 80px; font-size: 32px; } 
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top py-2">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#"><div class="logo-icon">üé≠</div><span>Kazu<span>Char</span>.AI</span></a>
            <div class="d-flex align-items-center gap-2">
                <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)"><option value="id">üáÆüá© ID</option><option value="en">üá∫üá∏ EN</option></select>
                <div class="token-badge"><i class="bi bi-coin me-1"></i><span id="tokenCount">0</span></div>
                <div class="dropdown">
                    <div class="user-dropdown d-flex align-items-center gap-2" data-bs-toggle="dropdown"><div class="user-avatar" id="userAvatar">üë§</div><span id="userName">User</span></div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-person-circle me-2"></i><span id="menuEditProfile">Edit Profile</span></a></li>
                        <li><a class="dropdown-item" href="#" id="adminLink" style="display:none;" onclick="location.href='/admin.html'"><i class="bi bi-gear me-2"></i>Admin</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i><span id="menuLogout">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <div class="container py-3">
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <button class="btn btn-filter active" onclick="filterNsfw('all', this)"><i class="bi bi-eye me-1"></i><span id="btnAll">Semua</span></button>
            <button class="btn btn-filter" onclick="filterNsfw('sfw', this)"><i class="bi bi-shield-check me-1"></i>SFW</button>
            <button class="btn btn-filter nsfw" onclick="filterNsfw('nsfw', this)" id="nsfwOnlyTab" style="display:none;"><i class="bi bi-heart me-1"></i>NSFW</button>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-12 col-md-4"><input type="text" class="form-control" id="searchInput" placeholder="üîç Cari karakter..." oninput="filterCharacters()"></div>
            <div class="col-4 col-md-2"><select class="form-select" id="filterGender" onchange="filterCharacters()"><option value="" id="optGender">Gender</option><option value="Pria" id="optMale">Pria</option><option value="Wanita" id="optFemale">Wanita</option></select></div>
            <div class="col-4 col-md-3"><select class="form-select" id="filterCategory" onchange="filterCharacters()"></select></div>
            <div class="col-4 col-md-3"><select class="form-select" id="filterTag" onchange="filterCharacters()"></select></div>
        </div>
        <div id="continueSection" style="display:none;"><h4 class="section-title"><i class="bi bi-chat-dots me-2"></i><span id="titleContinue">Lanjutkan Chat</span></h4><div class="row g-2 mb-4" id="continueGrid"></div></div>
        <div><h4 class="section-title"><i class="bi bi-people me-2"></i><span id="titleAllChar">Semua Karakter</span> <span class="count" id="totalChars"></span></h4><p class="update-note" id="updateNote">Data diperbarui setiap 15-30 menit.</p><div class="row g-2" id="charGrid"></div><nav class="mt-4"><ul class="pagination justify-content-center flex-wrap gap-1" id="pagination"></ul></nav></div>
    </div>
    <div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-person-circle me-2"></i><span id="modalTitleProfile">Edit Profile</span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="text-center mb-4"><div class="profile-avatar" id="editAvatar">üë§</div><input type="file" id="editPhoto" hidden accept="image/*" onchange="previewPhoto(event)"><button class="btn btn-sm btn-outline-light" onclick="document.getElementById('editPhoto').click()"><i class="bi bi-camera me-2"></i><span id="btnChangePhoto">Ganti Foto</span></button></div><div class="mb-3"><label class="form-label" id="lblName">Nama</label><input type="text" class="form-control" id="editName"></div><div class="mb-3"><label class="form-label" id="lblUsername">Username (tidak bisa diubah)</label><input type="text" class="form-control" id="editUsername" disabled></div><div class="mb-3"><label class="form-label" id="lblEmail">Email (tidak bisa diubah)</label><input type="email" class="form-control" id="editEmail" disabled></div></div><div class="modal-footer flex-column gap-2"><button class="btn btn-primary w-100" onclick="saveProfile()"><i class="bi bi-check-lg me-2"></i><span id="btnSave">Simpan</span></button><button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#passwordModal" data-bs-dismiss="modal"><i class="bi bi-key me-2"></i><span id="btnChangePass">Ganti Password</span></button></div></div></div></div>
    <div class="modal fade" id="passwordModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-key me-2"></i><span id="modalTitlePass">Ganti Password</span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert" style="background:rgba(108,92,231,0.1);border:1px solid var(--accent);color:var(--text);border-radius:12px;"><i class="bi bi-info-circle me-2"></i><span id="passNote">Password baru akan dikirim ke admin untuk disetujui.</span></div><div class="mb-3"><label class="form-label" id="lblNewPass">Password Baru</label><input type="password" class="form-control" id="newPassword" minlength="6"></div></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="requestPasswordChange()"><i class="bi bi-send me-2"></i><span id="btnSendPass">Kirim</span></button></div></div></div></div>
    <div class="chat-overlay" id="chatOverlay" onclick="closeChatWindow()"></div>
    <div class="chat-bubble"><button class="chat-bubble-btn" onclick="toggleChatWindow(event)"><i class="bi bi-chat-dots"></i><span class="badge bg-danger rounded-pill" id="unreadBadge" style="display:none;">0</span></button><div class="chat-window" id="chatWindow"><div class="chat-header"><div class="avatar">üë®‚Äçüíº</div><div><h6>Admin Support</h6><small><i class="bi bi-circle-fill text-success me-1" style="font-size:6px;"></i>Online</small></div></div><div class="chat-messages" id="chatMessages"></div><div class="chat-input"><input type="text" id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter')sendLiveChat()"><button type="button" onclick="sendLiveChat()"><i class="bi bi-send"></i></button></div></div></div>
    <div class="toast-container position-fixed top-0 end-0 p-3"><div id="toast" class="toast"><div class="toast-body d-flex align-items-center gap-2"><i class="bi" id="toastIcon"></i><span id="toastMessage"></span></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = window.location.origin + '/api';
        let token = localStorage.getItem('kazuchar_token'), user = JSON.parse(localStorage.getItem('kazuchar_user') || '{}');
        let allCharacters = [], categories = [], tags = [], currentNsfwFilter = 'all', adminId = null;
        let currentPage = 1, totalPages = 1, perPage = 10, totalChars = 0;
        let currentLang = localStorage.getItem('kazuchar_lang') || 'id';
        
        const translations = {
            id: {
                menuEditProfile: 'Edit Profile', menuLogout: 'Logout', btnAll: 'Semua',
                searchPlaceholder: 'üîç Cari karakter...', optGender: 'Gender', optMale: 'Pria', optFemale: 'Wanita',
                optCategory: 'Kategori', optTag: 'Sifat', titleContinue: 'Lanjutkan Chat', titleAllChar: 'Semua Karakter',
                updateNote: 'Data diperbarui setiap 15-30 menit.', modalTitleProfile: 'Edit Profile',
                btnChangePhoto: 'Ganti Foto', lblName: 'Nama', lblUsername: 'Username (tidak bisa diubah)',
                lblEmail: 'Email (tidak bisa diubah)', btnSave: 'Simpan', btnChangePass: 'Ganti Password',
                modalTitlePass: 'Ganti Password', passNote: 'Password baru akan dikirim ke admin untuk disetujui.',
                lblNewPass: 'Password Baru', btnSendPass: 'Kirim', chatPlaceholder: 'Ketik pesan...',
                characters: 'karakter', messages: 'pesan', noChar: 'Tidak ada karakter',
                profileSaved: 'Profile disimpan!', minPass: 'Minimal 6 karakter'
            },
            en: {
                menuEditProfile: 'Edit Profile', menuLogout: 'Logout', btnAll: 'All',
                searchPlaceholder: 'üîç Search characters...', optGender: 'Gender', optMale: 'Male', optFemale: 'Female',
                optCategory: 'Category', optTag: 'Traits', titleContinue: 'Continue Chats', titleAllChar: 'All Characters',
                updateNote: 'Data updated every 15-30 minutes.', modalTitleProfile: 'Edit Profile',
                btnChangePhoto: 'Change Photo', lblName: 'Name', lblUsername: 'Username (cannot change)',
                lblEmail: 'Email (cannot change)', btnSave: 'Save', btnChangePass: 'Change Password',
                modalTitlePass: 'Change Password', passNote: 'New password will be sent to admin for approval.',
                lblNewPass: 'New Password', btnSendPass: 'Send', chatPlaceholder: 'Type message...',
                characters: 'characters', messages: 'messages', noChar: 'No characters found',
                profileSaved: 'Profile saved!', minPass: 'Minimum 6 characters'
            }
        };
        
        const t = key => translations[currentLang][key] || key;
        
        const applyTranslations = () => {
            document.getElementById('menuEditProfile').textContent = t('menuEditProfile');
            document.getElementById('menuLogout').textContent = t('menuLogout');
            document.getElementById('btnAll').textContent = t('btnAll');
            document.getElementById('searchInput').placeholder = t('searchPlaceholder');
            document.getElementById('optGender').textContent = t('optGender');
            document.getElementById('optMale').textContent = t('optMale');
            document.getElementById('optFemale').textContent = t('optFemale');
            document.getElementById('titleContinue').textContent = t('titleContinue');
            document.getElementById('titleAllChar').textContent = t('titleAllChar');
            document.getElementById('updateNote').textContent = t('updateNote');
            document.getElementById('modalTitleProfile').textContent = t('modalTitleProfile');
            document.getElementById('btnChangePhoto').textContent = t('btnChangePhoto');
            document.getElementById('lblName').textContent = t('lblName');
            document.getElementById('lblUsername').textContent = t('lblUsername');
            document.getElementById('lblEmail').textContent = t('lblEmail');
            document.getElementById('btnSave').textContent = t('btnSave');
            document.getElementById('btnChangePass').textContent = t('btnChangePass');
            document.getElementById('modalTitlePass').textContent = t('modalTitlePass');
            document.getElementById('passNote').textContent = t('passNote');
            document.getElementById('lblNewPass').textContent = t('lblNewPass');
            document.getElementById('btnSendPass').textContent = t('btnSendPass');
            document.getElementById('chatInput').placeholder = t('chatPlaceholder');
            loadCategories();
            loadTags();
            updateCharCount();
        };
        
        const updateCharCount = () => {
            document.getElementById('totalChars').textContent = `(${totalChars} ${t('characters')})`;
        };
        
        if (!token) window.location.href = '/';
        
        const showToast = (msg, type = 'success') => { 
            document.getElementById('toastIcon').className = 'bi bi-' + (type === 'success' ? 'check-circle-fill text-success' : 'exclamation-circle-fill text-danger'); 
            document.getElementById('toastMessage').textContent = msg; 
            new bootstrap.Toast(document.getElementById('toast')).show(); 
        };
        
        const changeLanguage = lang => { 
            currentLang = lang; 
            localStorage.setItem('kazuchar_lang', lang); 
            applyTranslations();
            loadContinueChats();
            renderCharacters(allCharacters.filter(filterChar));
        };
        
        const filterChar = c => {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const gender = document.getElementById('filterGender').value;
            const category = document.getElementById('filterCategory').value;
            const tag = document.getElementById('filterTag').value;
            if (search && !c.name.toLowerCase().includes(search)) return false;
            if (gender && c.gender !== gender) return false;
            if (category && c.category !== category) return false;
            if (tag && (!c.tags || !c.tags.includes(tag))) return false;
            if (currentNsfwFilter === 'sfw' && c.nsfw_enabled) return false;
            if (currentNsfwFilter === 'nsfw' && !c.nsfw_enabled) return false;
            return true;
        };
        
        document.addEventListener('DOMContentLoaded', () => { 
            document.getElementById('langSelect').value = currentLang; 
            document.getElementById('userName').textContent = user.name || 'User'; 
            document.getElementById('tokenCount').textContent = user.tokens || 0; 
            if (user.profile_photo) document.getElementById('userAvatar').innerHTML = `<img src="${user.profile_photo}">`; 
            if (user.role === 'admin') document.getElementById('adminLink').style.display = 'block'; 
            if (user.nsfw_allowed) document.getElementById('nsfwOnlyTab').style.display = 'inline-flex'; 
            applyTranslations();
            loadUserInfo(); 
            loadCharacters(1); 
            loadContinueChats(); 
            loadLiveChatInfo(); 
            setInterval(checkUnread, 10000); 
        });
        
        const loadUserInfo = async () => { try { const res = await fetch(API + '/auth/me', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); if (data.user) { user = data.user; localStorage.setItem('kazuchar_user', JSON.stringify(user)); document.getElementById('tokenCount').textContent = user.tokens || 0; document.getElementById('userName').textContent = user.name || 'User'; if (user.profile_photo) document.getElementById('userAvatar').innerHTML = `<img src="${user.profile_photo}">`; if (user.nsfw_allowed) document.getElementById('nsfwOnlyTab').style.display = 'inline-flex'; } } catch(e) {} };
        
        const loadCategories = async () => { try { const res = await fetch(API + '/categories', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); categories = data.categories || []; document.getElementById('filterCategory').innerHTML = `<option value="">${t('optCategory')}</option>` + categories.map(c => `<option value="${c.name}">${c.icon} ${c.display_name}</option>`).join(''); } catch(e) {} };
        
        const loadTags = async () => { try { const res = await fetch(API + '/tags', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); tags = data.tags || []; document.getElementById('filterTag').innerHTML = `<option value="">${t('optTag')}</option>` + tags.map(tg => `<option value="${tg.name}">${tg.display_name}</option>`).join(''); } catch(e) {} };
        
        const loadCharacters = async (page) => { currentPage = page || 1; try { const res = await fetch(`${API}/characters?page=${currentPage}&limit=${perPage}`, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); allCharacters = data.characters || []; totalPages = data.pagination?.totalPages || 1; totalChars = data.pagination?.total || allCharacters.length; updateCharCount(); filterCharacters(); renderPagination(); } catch(e) {} };
        
        const loadContinueChats = async () => { try { const res = await fetch(API + '/user/character-history', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); const history = data.history || []; const section = document.getElementById('continueSection'), grid = document.getElementById('continueGrid'); if (history.length === 0) { section.style.display = 'none'; return; } section.style.display = 'block'; grid.innerHTML = history.slice(0, 4).map(h => { const imgHtml = h.profile_photo ? `<img src="${h.profile_photo}">` : h.name.charAt(0); return `<div class="col-6 col-md-3"><div class="continue-card d-flex" onclick="openChat(${h.id})"><div class="continue-img">${imgHtml}</div><div class="continue-info"><h6>${h.name}</h6><p class="meta">${h.message_count || 0} ${t('messages')}</p></div></div></div>`; }).join(''); } catch(e) {} };
        
        const filterNsfw = (filter, el) => { currentNsfwFilter = filter; document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active')); el.classList.add('active'); filterCharacters(); };
        
        const filterCharacters = () => { const filtered = allCharacters.filter(filterChar); renderCharacters(filtered); };
        
        const renderCharacters = chars => { const grid = document.getElementById('charGrid'); if (chars.length === 0) { grid.innerHTML = `<div class="col-12"><div class="empty-state"><i class="bi bi-emoji-frown d-block mb-2" style="font-size:40px;opacity:0.4;"></i>${t('noChar')}</div></div>`; return; } grid.innerHTML = chars.map(c => { const charTags = (c.tags || '').split(',').slice(0, 2).map(tg => { const tagData = tags.find(t => t.name === tg.trim()); return tagData ? `<span class="char-tag" style="background:${tagData.color}30;color:${tagData.color}">${tagData.display_name}</span>` : ''; }).join(''); const imgHtml = c.profile_photo ? `<img src="${c.profile_photo}">` : c.name.charAt(0); const nsfwBadge = c.nsfw_enabled ? '<span class="char-badge nsfw">üîû</span>' : ''; const genderIcon = c.gender === 'Pria' ? '‚ôÇ' : '‚ôÄ'; return `<div class="col-6 col-md-4 col-lg-3 col-xl-2"><div class="char-card" onclick="openChat(${c.id})"><div class="char-image">${imgHtml}${nsfwBadge}<span class="char-badge gender">${genderIcon}</span></div><div class="char-info"><h5>${c.name}</h5><p class="role">${c.role_title || 'AI'}</p><div class="char-tags">${charTags}</div></div></div></div>`; }).join(''); };
        
        const renderPagination = () => { const pag = document.getElementById('pagination'); if (totalPages <= 1) { pag.innerHTML = ''; return; } let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="goToPage(${currentPage - 1});return false;"><i class="bi bi-chevron-left"></i></a></li>`; const start = Math.max(1, currentPage - 2), end = Math.min(totalPages, currentPage + 2); if (start > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1);return false;">1</a></li>`; if (start > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>'; for (let i = start; i <= end; i++) html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="goToPage(${i});return false;">${i}</a></li>`; if (end < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>'; if (end < totalPages) html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages});return false;">${totalPages}</a></li>`; html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="goToPage(${currentPage + 1});return false;"><i class="bi bi-chevron-right"></i></a></li>`; pag.innerHTML = html; };
        
        const goToPage = page => { page = parseInt(page); if (page < 1 || page > totalPages) return; loadCharacters(page); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        const openChat = id => window.location.href = `/chat.html?id=${id}&lang=${currentLang}`;
        
        document.getElementById('profileModal').addEventListener('show.bs.modal', () => { document.getElementById('editName').value = user.name || ''; document.getElementById('editUsername').value = user.username || '-'; document.getElementById('editEmail').value = user.email || ''; document.getElementById('editAvatar').innerHTML = user.profile_photo ? `<img src="${user.profile_photo}">` : (user.name?.charAt(0) || 'üë§'); });
        
        const previewPhoto = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = ev => document.getElementById('editAvatar').innerHTML = `<img src="${ev.target.result}">`; reader.readAsDataURL(file); };
        
        const saveProfile = async () => { const formData = new FormData(); formData.append('name', document.getElementById('editName').value); const photo = document.getElementById('editPhoto').files[0]; if (photo) formData.append('photo', photo); try { const res = await fetch(API + '/auth/update-profile?type=profiles', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData }); const data = await res.json(); if (data.success) { user = data.user; localStorage.setItem('kazuchar_user', JSON.stringify(user)); document.getElementById('userName').textContent = user.name; if (user.profile_photo) document.getElementById('userAvatar').innerHTML = `<img src="${user.profile_photo}">`; showToast(t('profileSaved')); bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide(); } else showToast(data.error || 'Error', 'error'); } catch(e) { showToast('Error', 'error'); } };
        
        const requestPasswordChange = async () => { const newPass = document.getElementById('newPassword').value; if (newPass.length < 6) { showToast(t('minPass'), 'error'); return; } try { const res = await fetch(API + '/auth/request-password-change', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ new_password: newPass }) }); const data = await res.json(); if (data.success) { showToast(data.message); bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide(); } else showToast(data.error, 'error'); } catch(e) { showToast('Error', 'error'); } };
        
        const loadLiveChatInfo = async () => { try { const res = await fetch(API + '/live-chat/conversations', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); if (data.admin) { adminId = data.admin.id; if (data.unread > 0) { document.getElementById('unreadBadge').style.display = 'inline'; document.getElementById('unreadBadge').textContent = data.unread; } } } catch(e) {} };
        
        const checkUnread = async () => { try { const res = await fetch(API + '/live-chat/unread', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); const badge = document.getElementById('unreadBadge'); if (data.unread > 0) { badge.style.display = 'inline'; badge.textContent = data.unread; } else badge.style.display = 'none'; } catch(e) {} };
        
        const toggleChatWindow = (e) => { if(e) e.stopPropagation(); const win = document.getElementById('chatWindow'); const overlay = document.getElementById('chatOverlay'); win.classList.toggle('show'); overlay.classList.toggle('show'); if(win.classList.contains('show')) loadLiveMessages(); };
        
        const closeChatWindow = () => { document.getElementById('chatWindow').classList.remove('show'); document.getElementById('chatOverlay').classList.remove('show'); };
        
        const loadLiveMessages = async () => { if (!adminId) { try { const res = await fetch(API + '/live-chat/conversations', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); if (data.admin) adminId = data.admin.id; } catch(e) {} } if (!adminId) return; try { const res = await fetch(API + '/live-chat/messages/' + adminId, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('chatMessages').innerHTML = data.messages.map(m => `<div class="chat-msg ${m.from_user_id === user.id ? 'from-me' : 'from-admin'}">${m.message}</div>`).join(''); document.getElementById('chatMessages').scrollTop = 9999; document.getElementById('unreadBadge').style.display = 'none'; } catch(e) {} };
        
        const sendLiveChat = async () => { const input = document.getElementById('chatInput'); const msg = input.value.trim(); if (!msg || !adminId) return; await fetch(API + '/live-chat/send', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ to_user_id: adminId, message: msg }) }); input.value = ''; loadLiveMessages(); };
        
        const logout = () => { localStorage.removeItem('kazuchar_token'); localStorage.removeItem('kazuchar_user'); window.location.href = '/'; };
    </script>
</body>
</html>
