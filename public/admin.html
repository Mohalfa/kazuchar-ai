<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KazuChar.AI - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f0f1a; --bg-card: #1a1a2e; --bg-input: #252542; --accent: #6c5ce7; --accent-light: #a29bfe; --text: #ffffff; --text-muted: #8888aa; --border: rgba(255,255,255,0.1); --success: #00cec9; --error: #ff7675; --warning: #fdcb6e; }
        * { font-family: 'Poppins', sans-serif; box-sizing: border-box; }
        body { background: var(--bg-dark); color: var(--text); min-height: 100vh; margin: 0; }
        .navbar { background: rgba(26, 26, 46, 0.95) !important; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .navbar-brand { font-weight: 700; }
        .navbar-brand span { color: var(--accent-light); }
        .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .sidebar { width: 220px; background: var(--bg-card); border-right: 1px solid var(--border); min-height: calc(100vh - 56px); padding: 14px 10px; position: fixed; left: 0; top: 56px; overflow-y: auto; }
        .nav-item-custom { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 10px; color: var(--text-muted); cursor: pointer; margin-bottom: 4px; font-weight: 500; font-size: 13px; }
        .nav-item-custom:hover, .nav-item-custom.active { background: rgba(108,92,231,0.15); color: var(--accent-light); }
        .nav-item-custom .badge { margin-left: auto; font-size: 10px; }
        .main-content { margin-left: 220px; padding: 16px; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { margin-bottom: 16px; }
        .page-header h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
        .page-header p { color: var(--text-muted); font-size: 12px; margin: 0; }
        .card-custom { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 16px; }
        .card-header-custom { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; flex-wrap: wrap; gap: 8px; }
        .card-header-custom h5 { font-size: 0.95rem; font-weight: 600; margin: 0; }
        .user-row { background: var(--bg-input); border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; border: 1px solid var(--border); }
        .user-row:hover { border-color: rgba(108,92,231,0.3); }
        .user-row .name { font-weight: 600; font-size: 14px; color: var(--text); }
        .user-row .email { font-size: 12px; color: var(--text-muted); }
        .user-row .meta { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        .user-row .actions { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 16px; font-size: 10px; font-weight: 600; }
        .status-badge.pending { background: rgba(253, 203, 110, 0.2); color: var(--warning); }
        .status-badge.approved { background: rgba(0, 206, 201, 0.2); color: var(--success); }
        .btn-action { padding: 6px 12px; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; font-weight: 600; }
        .btn-action.approve { background: rgba(0, 206, 201, 0.2); color: var(--success); }
        .btn-action.approve:hover { background: var(--success); color: white; }
        .btn-action.reject { background: rgba(255, 118, 117, 0.2); color: var(--error); }
        .btn-action.reject:hover { background: var(--error); color: white; }
        .btn-action.edit { background: rgba(108, 92, 231, 0.2); color: var(--accent-light); }
        .btn-action.edit:hover { background: var(--accent); color: white; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 14px; }
        .char-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .char-image { width: 100%; height: 100px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); display: flex; align-items: center; justify-content: center; font-size: 36px; overflow: hidden; position: relative; }
        .char-image img { width: 100%; height: 100%; object-fit: cover; }
        .char-info { padding: 12px; }
        .char-info h6 { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .char-info .meta { color: var(--text-muted); font-size: 11px; }
        .char-actions { display: flex; gap: 6px; margin-top: 10px; }
        .char-actions button { flex: 1; padding: 8px; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; font-weight: 600; }
        .char-actions .edit { background: var(--bg-dark); color: var(--text); }
        .char-actions .delete { background: rgba(255, 118, 117, 0.2); color: var(--error); }
        .provider-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .provider-card.active { border-color: var(--success); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-item { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-input); border-radius: 16px; font-size: 12px; }
        .tag-item button { background: none; border: none; color: var(--error); cursor: pointer; }
        .live-chat-container { display: flex; gap: 14px; height: calc(100vh - 180px); }
        .live-chat-users { width: 260px; background: var(--bg-input); border-radius: 12px; overflow-y: auto; flex-shrink: 0; }
        .live-chat-user { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .live-chat-user:hover, .live-chat-user.active { background: rgba(108, 92, 231, 0.1); }
        .live-chat-user .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; font-size: 14px; }
        .live-chat-user .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .live-chat-user .info { flex: 1; min-width: 0; }
        .live-chat-user .info h6 { font-size: 13px; margin: 0 0 2px 0; }
        .live-chat-user .info p { font-size: 11px; color: var(--text-muted); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .live-chat-user .unread { background: var(--error); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; }
        .live-chat-user .delete-btn { background: none; border: none; color: var(--error); cursor: pointer; padding: 4px; opacity: 0.6; }
        .live-chat-messages { flex: 1; background: var(--bg-input); border-radius: 12px; display: flex; flex-direction: column; }
        .live-chat-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .live-chat-body { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; }
        .live-msg { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 13px; }
        .live-msg.from-user { background: var(--bg-dark); align-self: flex-start; }
        .live-msg.from-admin { background: linear-gradient(135deg, var(--accent), var(--accent-light)); align-self: flex-end; }
        .live-chat-input { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .live-chat-input input { flex: 1; padding: 10px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 20px; color: var(--text); font-size: 13px; }
        .live-chat-input button { padding: 10px 18px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border: none; border-radius: 20px; color: white; font-size: 12px; font-weight: 600; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; }
        .modal-header { border-bottom: 1px solid var(--border); padding: 16px 20px; }
        .modal-body { padding: 20px; }
        .modal-footer { border-top: 1px solid var(--border); padding: 12px 20px; }
        .btn-close { filter: invert(1); }
        .form-control, .form-select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 10px; padding: 10px 14px; font-size: 13px; }
        .form-control:focus, .form-select:focus { background: var(--bg-input); border-color: var(--accent); color: var(--text); box-shadow: none; }
        .form-control:disabled { background: var(--bg-dark); color: var(--text-muted); }
        .form-label { color: var(--text-muted); font-size: 12px; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-light)); border: none; border-radius: 10px; padding: 10px 20px; font-weight: 600; font-size: 13px; }
        .btn-outline-light { border: 1px solid var(--border); color: var(--text-muted); border-radius: 10px; font-size: 13px; }
        .form-check-input { background-color: var(--bg-input); border: 1px solid var(--border); width: 44px; height: 22px; }
        .form-check-input:checked { background-color: var(--accent); border-color: var(--accent); }
        .image-upload { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .image-preview { width: 80px; height: 80px; border-radius: 12px; background: var(--bg-input); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 28px; }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .empty-state { text-align: center; padding: 30px; color: var(--text-muted); font-size: 13px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } .live-chat-container { flex-direction: column; height: auto; } .live-chat-users { width: 100%; max-height: 200px; } .live-chat-messages { min-height: 300px; } .char-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top py-2">
        <div class="container-fluid px-3">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#"><div class="logo-icon">üé≠</div><span>Kazu<span>Char</span>.AI</span> <small class="text-muted ms-1">Admin</small></a>
            <div class="d-flex gap-2">
                <span class="badge bg-danger rounded-pill py-2 px-3" id="totalUnread" style="display:none;">0</span>
                <button class="btn btn-outline-light btn-sm" onclick="location.href='/dashboard.html'"><i class="bi bi-grid me-1"></i>Dashboard</button>
                <button class="btn btn-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
    </nav>
    <div class="sidebar">
        <div class="nav-item-custom active" onclick="showPage('pending', this)"><i class="bi bi-clock-history"></i>Pending<span class="badge bg-warning text-dark" id="pendingBadge">0</span></div>
        <div class="nav-item-custom" onclick="showPage('users', this)"><i class="bi bi-people"></i>Users</div>
        <div class="nav-item-custom" onclick="showPage('passwords', this)"><i class="bi bi-key"></i>Password<span class="badge bg-info" id="passwordBadge">0</span></div>
        <div class="nav-item-custom" onclick="showPage('characters', this)"><i class="bi bi-person-badge"></i>Karakter</div>
        <div class="nav-item-custom" onclick="showPage('categories', this)"><i class="bi bi-tags"></i>Kategori</div>
        <div class="nav-item-custom" onclick="showPage('providers', this)"><i class="bi bi-cpu"></i>Providers</div>
        <div class="nav-item-custom" onclick="showPage('settings', this)"><i class="bi bi-gear"></i>Settings</div>
        <div class="nav-item-custom" onclick="showPage('livechat', this)"><i class="bi bi-chat-dots"></i>Live Chat<span class="badge bg-danger" id="liveChatBadge" style="display:none;">0</span></div>
    </div>
    <main class="main-content">
        <div class="page active" id="page-pending">
            <div class="page-header"><h2>Pending Users</h2><p>Terima atau tolak pendaftaran</p></div>
            <div class="card-custom"><div class="card-header-custom"><h5>Daftar Pending</h5><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal"><i class="bi bi-plus-lg me-1"></i>Buat User</button></div><div id="pendingList"></div></div>
        </div>
        <div class="page" id="page-users">
            <div class="page-header"><h2>Semua Users</h2><p>Kelola users</p></div>
            <div class="card-custom"><div class="card-header-custom"><h5>Daftar Users</h5><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal"><i class="bi bi-plus-lg me-1"></i>Buat User</button></div><div id="usersList"></div></div>
        </div>
        <div class="page" id="page-passwords">
            <div class="page-header"><h2>Password Requests</h2><p>Permintaan password</p></div>
            <div class="card-custom"><div id="passwordList"></div></div>
        </div>
        <div class="page" id="page-characters">
            <div class="page-header"><h2>Karakter AI</h2><p>Kelola karakter</p></div>
            <div class="card-custom"><div class="card-header-custom"><h5>Daftar Karakter</h5><button class="btn btn-primary btn-sm" onclick="openCharModal()"><i class="bi bi-plus-lg me-1"></i>Tambah</button></div><div class="char-grid" id="charGrid"></div></div>
        </div>
        <div class="page" id="page-categories">
            <div class="page-header"><h2>Kategori & Tag</h2><p>Filter dashboard</p></div>
            <div class="card-custom"><div class="card-header-custom"><h5>Kategori</h5><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal"><i class="bi bi-plus-lg me-1"></i>Tambah</button></div><div class="tag-list" id="categoryList"></div></div>
            <div class="card-custom"><div class="card-header-custom"><h5>Tag</h5><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTagModal"><i class="bi bi-plus-lg me-1"></i>Tambah</button></div><div class="tag-list" id="tagList"></div></div>
        </div>
        <div class="page" id="page-providers">
            <div class="page-header"><h2>API Providers</h2><p>Konfigurasi AI</p></div>
            <div class="card-custom"><div id="providersList"></div></div>
        </div>
        <div class="page" id="page-settings">
            <div class="page-header"><h2>Pengaturan</h2><p>Setting aplikasi</p></div>
            <div class="card-custom"><h5 class="mb-3" style="font-size:14px;">Pengaturan Umum</h5><div class="mb-3"><label class="form-label">Default Token</label><input type="number" class="form-control" id="settingDefaultTokens" value="100" style="max-width:150px;"></div><div class="mb-3"><label class="form-label">Verifikasi Umur</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="settingNsfwReg" checked></div></div><button class="btn btn-primary" onclick="saveSettings()"><i class="bi bi-check-lg me-1"></i>Simpan</button></div>
        </div>
        <div class="page" id="page-livechat">
            <div class="page-header"><h2>Live Chat</h2><p>Chat dengan users</p></div>
            <div class="live-chat-container"><div class="live-chat-users" id="liveChatUsers"></div><div class="live-chat-messages"><div class="live-chat-header"><h6 id="liveChatPartnerName" style="font-size:14px;margin:0;">Pilih user</h6><button class="btn btn-sm btn-danger" id="deleteLiveChatBtn" style="display:none;font-size:11px;" onclick="deleteLiveChat()"><i class="bi bi-trash"></i></button></div><div class="live-chat-body" id="liveChatBody"></div><div class="live-chat-input" id="liveChatInputArea" style="display:none;"><input type="text" id="liveChatInput" placeholder="Ketik..." onkeypress="if(event.key==='Enter')sendLiveMessage()"><button onclick="sendLiveMessage()"><i class="bi bi-send me-1"></i>Kirim</button></div></div></div>
        </div>
    </main>
    <div class="modal fade" id="createUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" style="font-size:15px;"><i class="bi bi-person-plus me-2"></i>Buat User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="createUser(event)"><div class="mb-3"><label class="form-label">Nama</label><input type="text" class="form-control" id="newUserName" required></div><div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" id="newUserUsername"></div><div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="newUserEmail" required></div><div class="mb-3"><label class="form-label">Password</label><input type="password" class="form-control" id="newUserPassword" required minlength="6"></div><div class="mb-3"><label class="form-label">Token</label><input type="number" class="form-control" id="newUserTokens" value="100"></div><button type="submit" class="btn btn-primary w-100"><i class="bi bi-check-lg me-1"></i>Buat</button></form></div></div></div></div>
    <div class="modal fade" id="tokenModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" style="font-size:15px;"><i class="bi bi-coin me-2"></i>Token</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="tokenUserId"><p id="tokenUserName" class="mb-3" style="font-size:13px;"></p><div class="mb-3"><label class="form-label">Jumlah</label><input type="number" class="form-control" id="tokenAmount" value="100"></div><div class="d-flex gap-2"><button class="btn btn-primary flex-fill" onclick="setTokens('set')">Set</button><button class="btn btn-outline-light flex-fill" onclick="setTokens('add')">Tambah</button></div></div></div></div></div>
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" style="font-size:15px;"><i class="bi bi-key me-2"></i>Set Password</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="forgotRequestId"><p id="forgotUserName" class="mb-3" style="font-size:13px;"></p><div class="mb-3"><label class="form-label">Password Baru</label><input type="password" class="form-control" id="forgotNewPassword" minlength="6"></div><button class="btn btn-primary w-100" onclick="approveForgotPassword()"><i class="bi bi-check-lg me-1"></i>Set</button></div></div></div></div>
    <div class="modal fade" id="charModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="charModalTitle" style="font-size:15px;"><i class="bi bi-person-badge me-2"></i>Karakter</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="saveCharacter(event)"><input type="hidden" id="charId"><div class="image-upload mb-3"><div class="image-preview" id="charPreview">üì∑</div><input type="file" id="charPhoto" hidden accept="image/*" onchange="previewImg(event)"><button type="button" class="btn btn-sm btn-outline-light" onclick="document.getElementById('charPhoto').click()"><i class="bi bi-upload me-1"></i>Upload</button></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Nama *</label><input type="text" class="form-control" id="charName" required></div><div class="col-md-6 mb-3"><label class="form-label">Gender</label><select class="form-select" id="charGender"><option value="Pria">Pria</option><option value="Wanita">Wanita</option></select></div></div><div class="mb-3"><label class="form-label">Role</label><input type="text" class="form-control" id="charRole"></div><div class="row"><div class="col-md-4 mb-3"><label class="form-label">Kategori</label><select class="form-select" id="charCategory"></select></div><div class="col-md-4 mb-3"><label class="form-label">Provider</label><select class="form-select" id="charAiProvider"><option value="gemini">Gemini</option><option value="groq">Groq (Fast)</option><option value="openai">OpenAI</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option></select></div><div class="col-md-4 mb-3"><label class="form-label">Akses</label><select class="form-select" id="charAccessType" onchange="toggleUserList()"><option value="all">Semua</option><option value="specific">Tertentu</option></select></div></div><div class="mb-3"><label class="form-label">Tags</label><select class="form-select" id="charTags" multiple style="height:70px;"></select></div><div class="mb-3" id="userListContainer" style="display:none;"><label class="form-label">Users</label><div class="p-2 rounded" style="background:var(--bg-input);max-height:100px;overflow-y:auto;font-size:12px;" id="userCheckboxList"></div></div><div class="mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="charNsfw"><label class="form-check-label" for="charNsfw" style="font-size:13px;">NSFW</label></div></div><div class="mb-3"><label class="form-label">Kepribadian *</label><textarea class="form-control" id="charPersonality" required style="min-height:100px;"></textarea></div><button type="submit" class="btn btn-primary w-100"><i class="bi bi-check-lg me-1"></i>Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="addCategoryModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" style="font-size:15px;">Kategori</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="addCategory(event)"><div class="mb-3"><label class="form-label">Nama</label><input type="text" class="form-control" id="catName" required pattern="[a-z_]+"></div><div class="mb-3"><label class="form-label">Display</label><input type="text" class="form-control" id="catDisplay" required></div><div class="mb-3"><label class="form-label">Icon</label><input type="text" class="form-control" id="catIcon" value="üìÅ"></div><button type="submit" class="btn btn-primary w-100">Tambah</button></form></div></div></div></div>
    <div class="modal fade" id="addTagModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" style="font-size:15px;">Tag</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="addTag(event)"><div class="mb-3"><label class="form-label">Nama</label><input type="text" class="form-control" id="tagName" required pattern="[a-z_]+"></div><div class="mb-3"><label class="form-label">Display</label><input type="text" class="form-control" id="tagDisplay" required></div><div class="mb-3"><label class="form-label">Warna</label><input type="color" class="form-control form-control-color" id="tagColor" value="#6c5ce7"></div><button type="submit" class="btn btn-primary w-100">Tambah</button></form></div></div></div></div>
    <div class="toast-container position-fixed top-0 end-0 p-3"><div id="toast" class="toast"><div class="toast-body d-flex align-items-center gap-2"><i class="bi" id="toastIcon"></i><span id="toastMessage"></span></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = window.location.origin + '/api';
        let token = localStorage.getItem('kazuchar_token'), user = JSON.parse(localStorage.getItem('kazuchar_user') || '{}');
        let allUsers = [], categories = [], tags = [], currentLiveChatUser = null;
        if (!token || user.role !== 'admin') window.location.href = '/';
        const notify = (msg, type = 'success') => { document.getElementById('toastIcon').className = 'bi bi-' + (type === 'success' ? 'check-circle-fill text-success' : 'exclamation-circle-fill text-danger'); document.getElementById('toastMessage').textContent = msg; new bootstrap.Toast(document.getElementById('toast')).show(); };
        document.addEventListener('DOMContentLoaded', () => { loadPendingUsers(); loadAllUsers(); loadPasswordRequests(); loadCharacters(); loadProviders(); loadCategories(); loadTags(); loadSettings(); loadLiveChatUsers(); setInterval(loadLiveChatUsers, 15000); });
        const showPage = (page, el) => { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item-custom').forEach(n => n.classList.remove('active')); document.getElementById('page-' + page).classList.add('active'); if (el) el.classList.add('active'); };
        const loadPendingUsers = async () => { try { const res = await fetch(API + '/admin/pending-users', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('pendingBadge').textContent = data.users.length; document.getElementById('pendingList').innerHTML = data.users.length === 0 ? '<div class="empty-state">Tidak ada pending</div>' : data.users.map(u => `<div class="user-row"><div class="name">${u.name}</div><div class="email">${u.email}${u.username ? ' (@' + u.username + ')' : ''}</div><div class="meta">18+: ${u.age_verified ? '‚úÖ' : '‚ùå'} | ${new Date(u.created_at).toLocaleDateString('id')}</div><div class="actions"><button class="btn-action approve" onclick="updateUserStatus(${u.id}, 'approved')"><i class="bi bi-check me-1"></i>Terima</button><button class="btn-action reject" onclick="updateUserStatus(${u.id}, 'rejected')"><i class="bi bi-x me-1"></i>Tolak</button></div></div>`).join(''); } catch(e) {} };
        const loadAllUsers = async () => { try { const res = await fetch(API + '/admin/users', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); allUsers = data.users; document.getElementById('usersList').innerHTML = data.users.map(u => `<div class="user-row"><div class="d-flex justify-content-between align-items-start"><div><div class="name">${u.name}</div><div class="email">${u.email}${u.username ? ' (@' + u.username + ')' : ''}</div></div><span class="status-badge ${u.status}">${u.status}</span></div><div class="meta">Token: ${u.tokens} | NSFW: ${u.nsfw_allowed ? '‚úÖ' : '‚ùå'}</div><div class="actions"><button class="btn-action edit" onclick="openTokenModal(${u.id}, '${u.name.replace(/'/g, "\\'")}', ${u.tokens})"><i class="bi bi-coin me-1"></i>Token</button><button class="btn-action ${u.nsfw_allowed ? 'reject' : 'approve'}" onclick="toggleNsfw(${u.id}, ${u.nsfw_allowed ? 'false' : 'true'})">${u.nsfw_allowed ? 'üîû Off' : 'üîû On'}</button><button class="btn-action reject" onclick="deleteUser(${u.id})"><i class="bi bi-trash"></i></button></div></div>`).join(''); } catch(e) {} };
        const updateUserStatus = async (userId, status) => { await fetch(API + '/admin/user-status', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, status }) }); loadPendingUsers(); loadAllUsers(); notify('Updated'); };
        const deleteUser = async userId => { if (!confirm('Hapus?')) return; await fetch(API + '/admin/users/' + userId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadAllUsers(); notify('Dihapus'); };
        const createUser = async e => { e.preventDefault(); const res = await fetch(API + '/admin/create-user', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: document.getElementById('newUserName').value, username: document.getElementById('newUserUsername').value || null, email: document.getElementById('newUserEmail').value, password: document.getElementById('newUserPassword').value, tokens: parseInt(document.getElementById('newUserTokens').value) }) }); const data = await res.json(); if (data.success) { notify('Dibuat'); e.target.reset(); loadAllUsers(); bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide(); } else notify(data.error, 'error'); };
        const openTokenModal = (userId, name, tokens) => { document.getElementById('tokenUserId').value = userId; document.getElementById('tokenUserName').textContent = name + ' (' + tokens + ')'; document.getElementById('tokenAmount').value = 100; new bootstrap.Modal(document.getElementById('tokenModal')).show(); };
        const setTokens = async action => { await fetch(API + '/admin/user-tokens', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: document.getElementById('tokenUserId').value, tokens: parseInt(document.getElementById('tokenAmount').value), action }) }); loadAllUsers(); bootstrap.Modal.getInstance(document.getElementById('tokenModal')).hide(); notify('Updated'); };
        const toggleNsfw = async (userId, allow) => { await fetch(API + '/admin/user-nsfw', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, nsfw_allowed: allow }) }); loadAllUsers(); notify('Updated'); };
        const loadPasswordRequests = async () => { try { const res = await fetch(API + '/admin/password-requests', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('passwordBadge').textContent = data.requests.length; document.getElementById('passwordList').innerHTML = data.requests.length === 0 ? '<div class="empty-state">Tidak ada</div>' : data.requests.map(r => { const isForgot = r.request_type === 'forgot'; return `<div class="user-row"><div class="name">${r.name}</div><div class="email">${r.email}</div><div class="meta">${isForgot ? 'üîì Lupa' : 'üîë Ganti'} | ${new Date(r.created_at).toLocaleDateString('id')}</div><div class="actions">${isForgot ? `<button class="btn-action approve" onclick="openForgotModal(${r.id}, '${r.name.replace(/'/g, "\\'")}')">Set Password</button>` : `<button class="btn-action approve" onclick="updatePasswordRequest(${r.id}, 'approved')">Terima</button>`}<button class="btn-action reject" onclick="updatePasswordRequest(${r.id}, 'rejected')">Tolak</button></div></div>`; }).join(''); } catch(e) {} };
        const openForgotModal = (requestId, name) => { document.getElementById('forgotRequestId').value = requestId; document.getElementById('forgotUserName').textContent = name; document.getElementById('forgotNewPassword').value = ''; new bootstrap.Modal(document.getElementById('forgotPasswordModal')).show(); };
        const approveForgotPassword = async () => { const newPassword = document.getElementById('forgotNewPassword').value; if (newPassword.length < 6) { notify('Min 6 karakter', 'error'); return; } await fetch(API + '/admin/password-request-status', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ requestId: document.getElementById('forgotRequestId').value, status: 'approved', newPassword }) }); loadPasswordRequests(); bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal')).hide(); notify('Diset'); };
        const updatePasswordRequest = async (id, status) => { await fetch(API + '/admin/password-request-status', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ requestId: id, status }) }); loadPasswordRequests(); notify('Diproses'); };
        const loadCharacters = async () => { try { const res = await fetch(API + '/characters', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('charGrid').innerHTML = data.characters.length === 0 ? '<div class="empty-state">Belum ada</div>' : data.characters.map(c => { const imgHtml = c.profile_photo ? `<img src="${c.profile_photo}">` : c.name.charAt(0); return `<div class="char-card"><div class="char-image">${imgHtml}</div><div class="char-info"><h6>${c.name}</h6><p class="meta">${c.gender} | ${c.ai_provider || 'gemini'}${c.nsfw_enabled ? ' | üîû' : ''}</p><div class="char-actions"><button class="edit" onclick="editCharacter(${c.id})"><i class="bi bi-pencil me-1"></i>Edit</button><button class="delete" onclick="deleteCharacter(${c.id})"><i class="bi bi-trash"></i></button></div></div></div>`; }).join(''); } catch(e) {} };
        const openCharModal = () => { document.getElementById('charModalTitle').innerHTML = '<i class="bi bi-person-badge me-2"></i>Tambah'; document.getElementById('charId').value = ''; document.getElementById('charName').value = ''; document.getElementById('charGender').value = 'Pria'; document.getElementById('charRole').value = ''; document.getElementById('charPersonality').value = ''; document.getElementById('charAiProvider').value = 'gemini'; document.getElementById('charAccessType').value = 'all'; document.getElementById('charCategory').value = ''; document.getElementById('charNsfw').checked = false; document.getElementById('charPreview').innerHTML = 'üì∑'; document.getElementById('userListContainer').style.display = 'none'; Array.from(document.getElementById('charTags').options).forEach(o => o.selected = false); populateUserCheckboxes([]); new bootstrap.Modal(document.getElementById('charModal')).show(); };
        const editCharacter = async id => { try { const res = await fetch(API + '/characters/' + id, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); const c = data.character; document.getElementById('charModalTitle').innerHTML = '<i class="bi bi-person-badge me-2"></i>Edit'; document.getElementById('charId').value = c.id; document.getElementById('charName').value = c.name; document.getElementById('charGender').value = c.gender; document.getElementById('charRole').value = c.role_title || ''; document.getElementById('charPersonality').value = c.personality; document.getElementById('charAiProvider').value = c.ai_provider || 'gemini'; document.getElementById('charAccessType').value = c.access_type || 'all'; document.getElementById('charCategory').value = c.category || ''; document.getElementById('charNsfw').checked = c.nsfw_enabled == 1; document.getElementById('charPreview').innerHTML = c.profile_photo ? `<img src="${c.profile_photo}">` : 'üì∑'; const charTagList = c.tags ? c.tags.split(',').map(t => t.trim()) : []; Array.from(document.getElementById('charTags').options).forEach(o => o.selected = charTagList.includes(o.value)); populateUserCheckboxes(c.allowed_users ? c.allowed_users.split(',').map(id => parseInt(id.trim())) : []); toggleUserList(); new bootstrap.Modal(document.getElementById('charModal')).show(); } catch(e) {} };
        const saveCharacter = async e => { e.preventDefault(); const id = document.getElementById('charId').value; const formData = new FormData(); formData.append('name', document.getElementById('charName').value); formData.append('gender', document.getElementById('charGender').value); formData.append('role_title', document.getElementById('charRole').value); formData.append('personality', document.getElementById('charPersonality').value); formData.append('ai_provider', document.getElementById('charAiProvider').value); formData.append('access_type', document.getElementById('charAccessType').value); formData.append('allowed_users', Array.from(document.querySelectorAll('#userCheckboxList input:checked')).map(cb => cb.value).join(',')); formData.append('nsfw_enabled', document.getElementById('charNsfw').checked); formData.append('category', document.getElementById('charCategory').value); formData.append('tags', Array.from(document.getElementById('charTags').selectedOptions).map(o => o.value).join(',')); const photo = document.getElementById('charPhoto').files[0]; if (photo) formData.append('photo', photo); const url = id ? `${API}/admin/characters/${id}?type=characters` : `${API}/admin/characters?type=characters`; const res = await fetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData }); const data = await res.json(); if (data.success) { notify('Disimpan'); bootstrap.Modal.getInstance(document.getElementById('charModal')).hide(); loadCharacters(); } else notify(data.error, 'error'); };
        const deleteCharacter = async id => { if (!confirm('Hapus?')) return; await fetch(API + '/admin/characters/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadCharacters(); notify('Dihapus'); };
        const previewImg = e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = ev => document.getElementById('charPreview').innerHTML = `<img src="${ev.target.result}">`; reader.readAsDataURL(file); } };
        const toggleUserList = () => document.getElementById('userListContainer').style.display = document.getElementById('charAccessType').value === 'specific' ? 'block' : 'none';
        const populateUserCheckboxes = selected => { document.getElementById('userCheckboxList').innerHTML = allUsers.filter(u => u.status === 'approved').map(u => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${u.id}" id="user-${u.id}" ${selected.includes(u.id) ? 'checked' : ''}><label class="form-check-label" for="user-${u.id}">${u.name}</label></div>`).join(''); };
        const loadCategories = async () => { try { const res = await fetch(API + '/categories', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); categories = data.categories || []; document.getElementById('categoryList').innerHTML = categories.map(c => `<div class="tag-item">${c.icon} ${c.display_name}<button onclick="deleteCategory(${c.id})">√ó</button></div>`).join(''); document.getElementById('charCategory').innerHTML = '<option value="">--</option>' + categories.map(c => `<option value="${c.name}">${c.icon} ${c.display_name}</option>`).join(''); } catch(e) {} };
        const addCategory = async e => { e.preventDefault(); await fetch(API + '/admin/categories', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: document.getElementById('catName').value, display_name: document.getElementById('catDisplay').value, icon: document.getElementById('catIcon').value }) }); loadCategories(); bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide(); notify('Ditambahkan'); };
        const deleteCategory = async id => { if (!confirm('Hapus?')) return; await fetch(API + '/admin/categories/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadCategories(); notify('Dihapus'); };
        const loadTags = async () => { try { const res = await fetch(API + '/tags', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); tags = data.tags || []; document.getElementById('tagList').innerHTML = tags.map(t => `<div class="tag-item" style="background:${t.color}30;color:${t.color}">${t.display_name}<button onclick="deleteTag(${t.id})" style="color:${t.color}">√ó</button></div>`).join(''); document.getElementById('charTags').innerHTML = tags.map(t => `<option value="${t.name}">${t.display_name}</option>`).join(''); } catch(e) {} };
        const addTag = async e => { e.preventDefault(); await fetch(API + '/admin/tags', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: document.getElementById('tagName').value, display_name: document.getElementById('tagDisplay').value, color: document.getElementById('tagColor').value }) }); loadTags(); bootstrap.Modal.getInstance(document.getElementById('addTagModal')).hide(); notify('Ditambahkan'); };
        const deleteTag = async id => { if (!confirm('Hapus?')) return; await fetch(API + '/admin/tags/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadTags(); notify('Dihapus'); };
        const loadProviders = async () => { try { const res = await fetch(API + '/admin/providers', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('providersList').innerHTML = data.providers.map(p => { const models = (p.available_models || '').split(','); return `<div class="provider-card ${p.is_active ? 'active' : ''}"><div class="d-flex justify-content-between align-items-center mb-2"><h6 style="font-size:14px;margin:0;">${p.display_name}</h6><div class="form-check form-switch mb-0"><input class="form-check-input" type="checkbox" id="prov-active-${p.id}" ${p.is_active ? 'checked' : ''} onchange="updateProvider(${p.id})"></div></div><div class="row g-2"><div class="col-8"><input type="password" class="form-control" id="prov-key-${p.id}" value="${p.api_key || ''}" placeholder="API Key"></div><div class="col-4"><select class="form-select" id="prov-model-${p.id}">${models.map(m => `<option value="${m}" ${m === p.default_model ? 'selected' : ''}>${m}</option>`).join('')}</select></div></div><button class="btn btn-primary btn-sm mt-2" onclick="updateProvider(${p.id})">Simpan</button></div>`; }).join(''); } catch(e) {} };
        const updateProvider = async id => { await fetch(API + '/admin/providers/' + id, { method: 'PUT', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ api_key: document.getElementById('prov-key-' + id).value, default_model: document.getElementById('prov-model-' + id).value, is_active: document.getElementById('prov-active-' + id).checked }) }); loadProviders(); notify('Disimpan'); };
        const loadSettings = async () => { try { const res = await fetch(API + '/admin/settings', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('settingDefaultTokens').value = data.settings.default_tokens || 100; document.getElementById('settingNsfwReg').checked = data.settings.nsfw_registration === 'true'; } catch(e) {} };
        const saveSettings = async () => { await Promise.all([ fetch(API + '/admin/settings', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'default_tokens', value: document.getElementById('settingDefaultTokens').value }) }), fetch(API + '/admin/settings', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'nsfw_registration', value: document.getElementById('settingNsfwReg').checked ? 'true' : 'false' }) }) ]); notify('Disimpan'); };
        const loadLiveChatUsers = async () => { try { const res = await fetch(API + '/live-chat/conversations', { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); const conversations = data.conversations || []; const totalUnread = conversations.reduce((sum, c) => sum + (c.unread || 0), 0); const badge = document.getElementById('liveChatBadge'), headerBadge = document.getElementById('totalUnread'); if (totalUnread > 0) { badge.style.display = 'inline'; badge.textContent = totalUnread; headerBadge.style.display = 'inline'; headerBadge.textContent = totalUnread; } else { badge.style.display = 'none'; headerBadge.style.display = 'none'; } document.getElementById('liveChatUsers').innerHTML = conversations.length === 0 ? '<div class="empty-state">Belum ada</div>' : conversations.map(c => { const avatarHtml = c.profile_photo ? `<img src="${c.profile_photo}">` : c.name.charAt(0); return `<div class="live-chat-user ${currentLiveChatUser == c.id ? 'active' : ''}" onclick="openLiveChat(${c.id}, '${c.name.replace(/'/g, "\\'")}')"><div class="avatar">${avatarHtml}</div><div class="info"><h6>${c.name}</h6><p>${c.last_message || '-'}</p></div>${c.unread > 0 ? `<span class="unread">${c.unread}</span>` : ''}<button class="delete-btn" onclick="event.stopPropagation();confirmDeleteLiveChat(${c.id})"><i class="bi bi-trash"></i></button></div>`; }).join(''); } catch(e) {} };
        const openLiveChat = (userId, name) => { currentLiveChatUser = userId; document.getElementById('liveChatPartnerName').textContent = name; document.getElementById('liveChatInputArea').style.display = 'flex'; document.getElementById('deleteLiveChatBtn').style.display = 'block'; loadLiveMessages(); };
        const loadLiveMessages = async () => { if (!currentLiveChatUser) return; try { const res = await fetch(API + '/live-chat/messages/' + currentLiveChatUser, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); document.getElementById('liveChatBody').innerHTML = data.messages.map(m => `<div class="live-msg ${m.from_user_id === user.id ? 'from-admin' : 'from-user'}">${m.message}</div>`).join(''); document.getElementById('liveChatBody').scrollTop = 9999; loadLiveChatUsers(); } catch(e) {} };
        const sendLiveMessage = async () => { const input = document.getElementById('liveChatInput'); const msg = input.value.trim(); if (!msg || !currentLiveChatUser) return; await fetch(API + '/live-chat/send', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ to_user_id: currentLiveChatUser, message: msg }) }); input.value = ''; loadLiveMessages(); };
        const confirmDeleteLiveChat = async userId => { if (!confirm('Hapus chat?')) return; await fetch(API + '/admin/live-chat/' + userId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); if (currentLiveChatUser == userId) { currentLiveChatUser = null; document.getElementById('liveChatPartnerName').textContent = 'Pilih user'; document.getElementById('liveChatBody').innerHTML = ''; document.getElementById('liveChatInputArea').style.display = 'none'; document.getElementById('deleteLiveChatBtn').style.display = 'none'; } loadLiveChatUsers(); notify('Dihapus'); };
        const deleteLiveChat = () => { if (currentLiveChatUser) confirmDeleteLiveChat(currentLiveChatUser); };
        const logout = () => { localStorage.removeItem('kazuchar_token'); localStorage.removeItem('kazuchar_user'); window.location.href = '/'; };
    </script>
</body>
</html>
